version: 2.1

executors:
  go-executor:
    docker:
      - image: cimg/go:1.21
      - image: postgres:15
        environment:
          POSTGRES_USER: items_user
          POSTGRES_PASSWORD: items_pass
          POSTGRES_DB: items_db
    working_directory: ~/repo

jobs:
  test:
    executor: go-executor
    environment:
      DB_MAX_RETRIES: 5
      DB_RETRY_DELAY: 2
    steps:
      - checkout
      - run:
          name: Install Postgres Client
          command: |
            sudo apt-get update && sudo apt-get install -y postgresql-client
      - run:
          name: Wait for Postgres
          command: |
            for i in `seq 1 10`; do
              nc -z localhost 5432 && echo "Postgres is up" && exit 0
              echo "Waiting for Postgres..."
              sleep 2
            done
            echo "Postgres failed to start" && exit 1
      - run:
          name: Run DB Migrations
          command: |
            psql -h localhost -U items_user -d items_db -f migrations/0001_create_items.sql
      - run:
          name: Install gotestsum
          command: go install gotest.tools/gotestsum@latest
      - run:
          name: Run Tests
          command: |
            mkdir -p test-results
            $(go env GOPATH)/bin/gotestsum --junitfile test-results/unit-tests.xml ./...
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results

  build:
    docker:
      - image: cimg/base:stable
    working_directory: ~/repo
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Skip build on docs-only changes
          command: |
            set -euo pipefail
            base_ref="${CIRCLE_BRANCH:-main}"
            git fetch origin "$base_ref" --depth=1
            CHANGED=$(git diff --name-only "$(git merge-base HEAD origin/$base_ref)" HEAD)
            if echo "$CHANGED" | grep -vE '^(README\.md|docs/)' >/dev/null; then
              echo "Changes affect build. Continuing."
            else
              echo "Docs-only change. Halting build job."
              circleci step halt
            fi
      - run:
          name: Build Docker Image
          command: docker build -t fifo-app:latest .
      - run:
          name: Save Docker Image
          command: docker save fifo-app:latest -o fifo-app.tar
      - store_artifacts:
          path: fifo-app.tar

  push-ecr:
    docker:
      - image: cimg/aws:2023.01
    working_directory: ~/repo
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Configure AWS ECR and Push Image
          command: |
            set -euo pipefail
            : "${AWS_REGION:=us-west-2}"
            : "${AWS_ROLE_ARN:?AWS_ROLE_ARN must be set in CircleCI project env vars}"

            echo "$CIRCLE_OIDC_TOKEN_V2" > /tmp/oidc-token
            export AWS_WEB_IDENTITY_TOKEN_FILE=/tmp/oidc-token

            aws sts get-caller-identity

            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            REPO_NAME=fifo-app
            ECR_REGISTRY="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

            aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "$ECR_REGISTRY"

            docker build -t "${ECR_REGISTRY}/${REPO_NAME}:latest" .
            docker push "${ECR_REGISTRY}/${REPO_NAME}:latest"

workflows:
  version: 2
  build-test-and-push:
    jobs:
      - test
      - build:
          requires: [test]
      - push-ecr:
          requires: [build]
          filters:
            branches:
              only: main
